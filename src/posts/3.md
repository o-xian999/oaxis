---
title: Gridsomeで複数ディレクトリから記事一覧を表示する
date: 2020/09/28
---
# Gridsomeで複数ディレクトリから記事一覧を表示する

## はじめに
[Gridsome](https://gridsome.org/)は様々なデータを静的サイトとして表示することができます。今回はサークルのホームページを作成する時にハマった部分の整理も兼ねて、複数のディレクトリ配下にあるマークダウンファイルの一覧を一枚のページに表示する方法を書いていきます。

## そもそも
Gridsomeは[Gatsby](https://www.gatsbyjs.com/)に強くインスパイアされて開発された静的サイトジェネレーターです。GatsbyがReact製であるのに対し、GridsomeはVueで開発されています。仕組みとしては、CMSやマークダウンファイルのデータから、タイトル・日付・本文情報などの記事データをGraphQLで引っ張ってきて、それらをを複数のページで必要に応じて表示します。これらのデータの引っ張り方を理解することで少々複雑な挙動も可能になっていきます。

## マークダウンファイルのデータをGrapgQLデータレイヤーにインポートする
これから、「ニュース」セクションと「プロダクト」セクションの記事を別々のディレクトリでで管理しながら、一括でデータをインポートしてトップページに表示する作業を行います。
まず、以下のコマンドを叩いて、手元の環境にGridsomeのDefault starterを作成します。
```sh
$ gridsome create sample
    ❯ Clone https://github.com/gridsome/gridsome-starter-default.git 2.05s
    ❯ Update project package.json 0.01s
    ❯ Install dependencies 22.03s

    - Enter directory cd sample
    - Run gridsome develop to start local development
    - Run gridsome build to build for production
```
おそらく、プロジェクトディレクトリ配下はこのようなファイル構造になっているはずです。
```
.
├── gridsome.config.js
├── gridsome.server.js
├── node_modules
├── package.json
├── README.md
├── src
├── static
└── yarn.lock
```
今回はマークダウンファイルをデータに持っていきたいので、マークダウンファイルをGraphQLデータにインポートできるGridsomeプラグインを導入します。今回は`@gridsome/vue-remark`というプラグインを、以下のコマンドでぶち込みます。今回は`Yarn`を使用しています。
```sh
$ yarn add @gridsome/vue-remark
    yarn add v1.22.5
    [1/4] Resolving packages...
    [2/4] Fetching packages...
    .
    .
    .
    Done in 10.34s.
```
上記のように`@gridsome/vue-remark`の導入が終わったら、`gridsome.config.js`に以下のような書き込みを行います。
```js
//gridsome.config.js
module.exports = {
  siteName: 'Gridsome',
  plugins: [
    {
      use: '@gridsome/vue-remark',
      options: {
        typeName: 'NewsPost', // 必須。GraphQL上で扱う型定義
        baseDir: './posts/news', // 記事となるmarkdownファイルを置くディレクトリ
        pathPrefix: '/news', // URLになるパス。必須ではない。
        template: './src/templates/NewsPost.vue' // 記事ページのVueコンポーネントファイルの指定
      }
    },
    {
      use: '@gridsome/vue-remark',
      options: {
        typeName: 'ProductPost', // 必須。GraphQL上で扱う型定義
        baseDir: './posts/products', // 記事となるmarkdownファイルを置くディレクトリ
        pathPrefix: '/products', // URLになるパス。必須ではない。
        template: './src/templates/ProductPost.vue' // 記事ページのVueコンポーネントファイルの指定
      }
    }  
  ]
}
```
これらの書き方は[@gridsome/vue-remarkプラグインの公式サイト](https://gridsome.org/plugins/@gridsome/vue-remark)にしっかりと載っています。ここに載っている書き方の例と比較すると、上記の記述ではいくつか異なる部分が見受けられるはずです。この部分は以下のように解説できます。
- マークダウンファイルをデータとして利用するには、**マークダウンファイルを入れておくディレクトリがそれぞれのGraphQL上の型1つにつき1つ必要**。
- そのために「ニュース」と「プロダクト」のそれぞれに対して、**GraphQL上の型・格納するディレクトリ・パス・テンプレートファイル**の指定を行っている。
- 先程導入したプラグインを、「ニュース」と「プロダクト」のそれぞれに対して適用させている。

この`gridsome.config.js`が、Gridsomeのプロジェクトのデータ設定になるので、ここは非常に重要となります。この設定一つでデータを読み込めなかったりするので、しっかり記述します。  

データの定義が完了したので、次はデータとなるマークダウンファイルを格納するディレクトリを作成します。

```
mkdir posts/news
mkdir posts/products
```

2つのディレクトリの中には、以下のような形式でマークダウンファイルを作成します。両方のディレクトリにこの形式のマークダウンファイルがないとエラーを吐きますので、2つともファイルを作成しておきましょう。

```md
---
title: "成功していればここにタイトルが表示されます"
---

## これは最初の投稿です

マークダウンで記事一覧を表示することかできたぞ!やったぜ!  
テンションあがるなｧ＾〜
```

こうしてマークダウンファイルを作成しました。これらの情報が、先程のプラグインによってGraphQLデータレイヤーにインポートされます。具体的には
- title: マークダウンファイルで`title`を記述した部分
- content: 記事本文

の2つに加え、
- id: 各マークダウンファイルに対応する一意の文字列

の3つの情報がインポートされています。以降は、これらデータレイヤー上のデータを必要に応じてQuery:照会していきます。

## GraphQLデータレイヤー上のデータをクエリ(照会)して、投稿一覧ページを作る
次に各ページにGraphQLを記述して、データレイヤー上にインポートされたデータから必要なデータを問い合わせていきます。`Index.vue`に記述されているデフォルトの記事に、GraphQLの項目を追記していきます。

```Vue
<!-- Index.vue -->
<template>
<Layout>
    <h1>Hello, world!</h1>
    .
    .
    .
    <div>
      <h1>News</h1>
      <g-link 
        v-for="news in $page.allNewsPost.edges"
        :key="news.node.id" 
        :to="news.node.path">
          <h2>{{ news.node.title }}</h2>
      </g-link>
    </div>

    <div>
      <h1>Products</h1>
      <g-link 
        v-for="product in $page.allProductPost.edges"
        :key="product.node.id" 
        :to="product.node.path">
          <h2>{{ product.node.title }}</h2>
      </g-link>
    </div>
</Layout>
</template>

<page-query>
  query{
    allNewsPost{
      edges{
        node{
          id
          title
          path
        }
      }
    },
    allProductPost{
      edges{
        node{
          id
          title
          path
        }
      }
    }
  }
</page-query>

<script>
.
.
.
</script>

<style>
.
.
.
</style>
```

ここでは以下のような動作を定義しています。

- `<page-query>`内では、`gridsome.config.js`で定義したGraphQLデータ型を参考に、`all[型名]`という名前で指定した型の持つすべてのデータを指定します(ここでは`NewsPost`型と`ProductPost`型のデータを全て参照する`allNewsPost`と`allProductPost`を用いています)。このページでは、これらのデータを指定の書き方で参照して利用していきます。
- g-link内では以下の操作を行っています
- $pageでこのページのデータを全て参照しておいて、`news in $page.allNewsPost.edges`でNewsPostのedge以下にあるデータに`news`と名付けて、v-forで繰り返し表示しています。
- `:key`でv-forする際の個々のファイルの識別、`:path`でブラウザ表示した際の個々のマークダウンファイルに対応したパスの受け渡しを行っています。
- `news.node.title`で、マークダウンファイルのフロントマターのtitle情報をデータレイヤー上から持ってきて表示しています。

これらは`News`を対象としていますが、全く同様の操作を`Product`でも行えば大丈夫です。この操作をすることで、トップページに記事のタイトルが一覧として表示されます。  
最後に、各マークダウンファイルを表示する時に利用するVueファイルを作成していきます。`./src/templates`配下に`NewsPost.vue`というVueファイルを作成します。

```
<template>
  <article>
    <h1>{{ $page.newsPost.title }}</h1>
    <VueRemarkContent/>
  </article>
</template>

<page-query>
query NewsPost ($id: ID!) {
  newsPost(id: $id) {
    title
    content
  }
}
</page-query>
```

ここでは以下の操作を行っています。
- 先程同様、データレイヤー上のデータから`<page-query>`内でデータを参照します。今回では、`NewsPost`型のマークダウンファイルデータのうち、`title`(記事のタイトル：フロントマター内の記述)と`content`(記事本文：フロントマターより下にある記述)を`newsPost`と名前をつけて照会しています。
- `$page.newsPost.title`で同様に`title`データを、`<VueRemarkContent/>`で`content`データを表示します(`<VueRemarkContent/>`はプラグインで定められた記述です)。

`Product`でも全く同様のことを記述していけばよいです。その際は、照会するデータ型が`NewsPost`型と`ProductPost`型で違うので、別途`ProductPost.vue`のようなVueテンプレートを作成していくと良いでしょう。

## まとめ
GraphQLが具体的にどんなことをやっているのかを理解できたのはデカいと思います。GraphQlを除けば、Gridsomeは実質Vueみたいなものなので(King of 安直)。いつの日か断念していたGatsby開発も、GraphQLの挙動を理解した状態でリベンジできるんじゃねとちょっと思いますた。

## 参考

